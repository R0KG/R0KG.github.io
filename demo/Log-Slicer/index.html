<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Log Slicer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.min.css" />
    <style>
      #out {
        white-space: pre-wrap;
        background: #0b1020;
        color: #e6edf3;
        border-radius: 8px;
        padding: 12px;
        max-height: 60vh;
        overflow: auto;
      }
      .CodeMirror {
        border: 1px solid #2d3748;
        border-radius: 8px;
        height: 150px;
      }
      .drop-zone {
        border: 2px dashed #cbd5e1;
        border-radius: 8px;
        padding: 12px;
        text-align: center;
        background: #f8fafc;
      }
      .drop-zone.dragover {
        background: #eff6ff;
        border-color: #3b82f6;
      }
      .status {
        font-size: 0.875rem;
        color: #4b5563;
      }
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
      }
      mark {
        background: #fde68a;
        color: #111827;
        padding: 0 2px;
        border-radius: 2px;
      }
    </style>
  </head>
  <body>
    <main class="max-w-6xl mx-auto p-6">
      <div class="flex items-center justify-between gap-4">
        <div>
          <h1 class="text-3xl font-semibold">Log Slicer</h1>
          <p class="text-gray-600">Open a .log file and filter locally. Preview, highlight, and export.</p>
        </div>
        <div class="hidden md:flex items-center gap-2 text-sm text-gray-500">
          <span class="px-2 py-1 rounded bg-gray-100">⌘/Ctrl+Enter Apply</span>
          <span class="px-2 py-1 rounded bg-gray-100">⌘/Ctrl+Backspace Reset</span>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
        <div class="md:col-span-1 space-y-4">
          <div class="drop-zone" id="dropZone">
            <div class="text-gray-700">Drop a .log file here or</div>
            <div class="mt-2">
              <input id="file" type="file" accept=".log,.txt" class="block w-full border rounded px-3 py-2" />
            </div>
            <p id="error" class="text-red-600 text-sm mt-2 hidden"></p>
          </div>

          <div class="rounded border p-3">
            <div class="font-medium mb-2">Dataset</div>
            <dl class="grid grid-cols-3 gap-1 text-sm">
              <dt class="text-gray-500">File</dt>
              <dd id="metaFile" class="col-span-2 mono">—</dd>
              <dt class="text-gray-500">Lines</dt>
              <dd id="metaLines" class="col-span-2">0</dd>
              <dt class="text-gray-500">Shown</dt>
              <dd id="metaShown" class="col-span-2">0</dd>
            </dl>
          </div>

          <div class="rounded border p-3 space-y-2">
            <div class="font-medium">Quick filters</div>
            <div class="flex items-center gap-2">
              <label class="text-sm text-gray-600">Join</label>
              <select id="joinOp" class="border rounded px-2 py-1 text-sm">
                <option value="AND" selected>AND</option>
                <option value="OR">OR</option>
              </select>
              <label class="text-sm text-gray-600 flex items-center gap-1"
                ><input id="caseSensitive" type="checkbox" class="align-middle" /> Case</label
              >
              <label class="text-sm text-gray-600 flex items-center gap-1"
                ><input id="showLineNumbers" type="checkbox" class="align-middle" /> Line #</label
              >
              <label class="text-sm text-gray-600 flex items-center gap-1"
                ><input id="highlightMatches" type="checkbox" class="align-middle" checked /> Highlight</label
              >
            </div>
            <div class="flex flex-wrap gap-2">
              <button data-level="ERROR" class="level-chip px-2 py-1 rounded text-xs bg-red-100 text-red-700">
                ERROR
              </button>
              <button data-level="WARN" class="level-chip px-2 py-1 rounded text-xs bg-yellow-100 text-yellow-700">
                WARN
              </button>
              <button data-level="INFO" class="level-chip px-2 py-1 rounded text-xs bg-blue-100 text-blue-700">
                INFO
              </button>
            </div>
            <div id="condList" class="space-y-2 max-h-56 overflow-auto"></div>
            <div class="flex items-center gap-2">
              <button id="addCond" class="px-2 py-1 rounded bg-blue-600 text-white text-sm">Add condition</button>
              <button id="clearConds" class="px-2 py-1 rounded bg-gray-100 text-sm">Clear</button>
            </div>
            <div class="flex items-center gap-2">
              <label class="text-sm text-gray-600" for="limit">Limit</label>
              <input id="limit" type="number" value="500" min="1" class="w-28 border rounded px-2 py-1 text-sm" />
              <button id="apply" class="ml-auto px-3 py-2 rounded bg-blue-600 text-white">Apply</button>
            </div>
          </div>

          <details class="rounded border p-3">
            <summary class="cursor-pointer font-medium">Advanced predicate (JavaScript)</summary>
            <p class="text-sm text-gray-600 mb-2">
              Runs locally: function of form <span class="mono">line => boolean</span>.
            </p>
            <textarea id="filter" style="display: none">line => line.includes('ERROR')</textarea>
            <div id="editor" class="mt-2"></div>
          </details>

          <div class="flex gap-2">
            <button id="resetAll" class="px-3 py-2 rounded bg-gray-100">Reset</button>
            <button id="export" class="px-3 py-2 rounded bg-green-600 text-white">Export</button>
          </div>
        </div>

        <div class="md:col-span-2">
          <div class="rounded border p-3">
            <div id="out" class="mono"></div>
            <div class="flex justify-between items-center mt-3 status">
              <div>Showing <span id="shownCount">0</span> / <span id="totalCount">0</span></div>
              <div class="flex items-center gap-2">
                <button id="copy" class="px-2 py-1 rounded bg-gray-100 text-sm">Copy</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/javascript/javascript.min.js"></script>
    <script>
      let lines = []
      let filtered = []
      let filename = '—'
      let debounceTimer = null

      const elFile = document.getElementById('file')
      const elDrop = document.getElementById('dropZone')
      const elError = document.getElementById('error')
      const elFilter = document.getElementById('filter')
      const elLimit = document.getElementById('limit')
      const elOut = document.getElementById('out')
      const elShown = document.getElementById('shownCount')
      const elTotal = document.getElementById('totalCount')
      const elMetaFile = document.getElementById('metaFile')
      const elMetaLines = document.getElementById('metaLines')
      const elMetaShown = document.getElementById('metaShown')
      const elJoin = document.getElementById('joinOp')
      const elCase = document.getElementById('caseSensitive')
      const elLineNos = document.getElementById('showLineNumbers')
      const elHighlight = document.getElementById('highlightMatches')

      const editor = CodeMirror(document.getElementById('editor'), {
        value: elFilter.value,
        mode: 'javascript',
        lineNumbers: true,
      })

      function debounce(fn, ms = 250) {
        return (...args) => {
          clearTimeout(debounceTimer)
          debounceTimer = setTimeout(() => fn(...args), ms)
        }
      }
      function showError(msg) {
        elError.textContent = msg || ''
        elError.classList.toggle('hidden', !msg)
      }
      function escapeHtml(s) {
        return s.replace(
          /[&<>"']/g,
          (c) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[c],
        )
      }
      function updateMeta() {
        elMetaFile.textContent = filename || '—'
        elMetaLines.textContent = String(lines.length)
        elMetaShown.textContent = String(filtered.length)
        elTotal.textContent = String(lines.length)
        elShown.textContent = String(filtered.length)
      }

      function addConditionRow(prefill = {}) {
        const row = document.createElement('div')
        row.className = 'flex items-center gap-2'
        const opSel = document.createElement('select')
        opSel.className = 'border rounded px-2 py-1 text-sm cond-op'
        ;['contains', 'notContains', 'startsWith', 'endsWith', 'matches'].forEach((op) => {
          const o = document.createElement('option')
          o.value = op
          o.textContent = op
          opSel.appendChild(o)
        })
        if (prefill.op) opSel.value = prefill.op
        const val = document.createElement('input')
        val.className = 'border rounded px-2 py-1 text-sm flex-1 cond-val'
        val.type = 'text'
        val.placeholder = 'value or /regex/'
        if (prefill.val) val.value = prefill.val
        const rm = document.createElement('button')
        rm.className = 'px-2 py-1 rounded bg-gray-100 text-sm'
        rm.textContent = 'Remove'
        rm.addEventListener('click', () => {
          row.remove()
          applyFilters()
        })
        opSel.addEventListener('change', debounce(applyFilters, 150))
        val.addEventListener('input', debounce(applyFilters, 200))
        row.appendChild(opSel)
        row.appendChild(val)
        row.appendChild(rm)
        document.getElementById('condList').appendChild(row)
      }

      function gatherHighlightRegex() {
        const parts = []
        document.querySelectorAll('#condList .cond-op').forEach((opEl, idx) => {
          const op = opEl.value
          const val = document.querySelectorAll('#condList .cond-val')[idx].value
          if (!val) return
          if (op === 'matches') {
            const m = /^\/(.*)\/(.*)?$/.exec(val)
            if (m) parts.push(m[1])
          } else if (op === 'contains' || op === 'startsWith' || op === 'endsWith') {
            parts.push(val.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'))
          }
        })
        if (!parts.length) return null
        const flags = elCase.checked ? 'g' : 'gi'
        try {
          return new RegExp(parts.join('|'), flags)
        } catch {
          return null
        }
      }

      function compileQuickPredicate() {
        const ops = Array.from(document.querySelectorAll('#condList .cond-op'))
        const vals = Array.from(document.querySelectorAll('#condList .cond-val'))
        const conds = ops.map((opEl, i) => ({ op: opEl.value, val: vals[i].value }))
        const join = elJoin.value
        const sensitive = elCase.checked
        if (!conds.length) return () => true
        const testers = conds.map(({ op, val }) => {
          if (!val) return () => true
          if (op === 'matches') {
            const m = /^\/(.*)\/(.*)?$/.exec(val)
            let re = null
            try {
              re = m ? new RegExp(m[1], (m[2] || '') + (sensitive ? '' : 'i')) : new RegExp(val, sensitive ? '' : 'i')
            } catch {
              re = null
            }
            if (!re) return () => false
            return (line) => re.test(line)
          }
          const needle = sensitive ? val : val.toLowerCase()
          return (line) => {
            const hay = sensitive ? line : line.toLowerCase()
            if (op === 'contains') return hay.includes(needle)
            if (op === 'notContains') return !hay.includes(needle)
            if (op === 'startsWith') return hay.startsWith(needle)
            if (op === 'endsWith') return hay.endsWith(needle)
            return true
          }
        })
        if (join === 'OR') return (line) => testers.some((t) => t(line))
        return (line) => testers.every((t) => t(line))
      }

      function applyFilters() {
        if (!lines.length) {
          filtered = []
          renderOutput()
          updateMeta()
          return
        }
        let pred = compileQuickPredicate()
        const adv = editor.getValue()
        if (adv && adv.trim() !== "line => line.includes('ERROR')") {
          try {
            const advFn = eval('(' + adv + ')')
            const prev = pred
            pred = (line) => prev(line) && advFn(line)
          } catch (e) {
            showError('Advanced predicate error: ' + (e && e.message ? e.message : String(e)))
          }
        } else {
          showError('')
        }
        const limit = Math.max(1, Number(elLimit.value) || 500)
        const result = []
        for (const line of lines) {
          if (pred(line)) {
            result.push(line)
            if (result.length >= limit) break
          }
        }
        filtered = result
        renderOutput()
        updateMeta()
        window.__last = filtered
      }

      function renderOutput() {
        const showNos = elLineNos.checked
        const doHighlight = elHighlight.checked
        const re = doHighlight ? gatherHighlightRegex() : null
        let idx = 0
        const content = filtered
          .map((line) => {
            idx++
            let safe = escapeHtml(line)
            if (re) safe = safe.replace(re, (m) => `<mark>${escapeHtml(m)}</mark>`)
            if (showNos) return String(idx).padStart(6, ' ') + '  ' + safe
            return safe
          })
          .join('\n')
        if (re) {
          elOut.innerHTML = content.replace(/\n/g, '<br/>')
        } else {
          elOut.textContent = content
        }
      }

      async function handleFile(file) {
        if (!file) return
        showError('')
        filename = file.name
        const text = await file.text()
        lines = text.split(/\r?\n/)
        filtered = lines.slice(0, Math.min(300, lines.length))
        renderOutput()
        updateMeta()
      }

      // File input & DnD
      elFile.addEventListener('change', () => {
        const f = elFile.files && elFile.files[0]
        handleFile(f)
      })
      ;['dragenter', 'dragover'].forEach((evt) =>
        elDrop.addEventListener(evt, (e) => {
          e.preventDefault()
          e.stopPropagation()
          elDrop.classList.add('dragover')
        }),
      )
      ;['dragleave', 'drop'].forEach((evt) =>
        elDrop.addEventListener(evt, (e) => {
          e.preventDefault()
          e.stopPropagation()
          elDrop.classList.remove('dragover')
        }),
      )
      elDrop.addEventListener('drop', (e) => {
        const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0]
        if (f) {
          elFile.files = e.dataTransfer.files
          handleFile(f)
        }
      })

      // Controls
      document.getElementById('apply').addEventListener('click', applyFilters)
      document.getElementById('addCond').addEventListener('click', () => addConditionRow())
      document.getElementById('clearConds').addEventListener('click', () => {
        document.getElementById('condList').innerHTML = ''
        applyFilters()
      })
      elJoin.addEventListener('change', applyFilters)
      elCase.addEventListener('change', applyFilters)
      elLineNos.addEventListener('change', renderOutput)
      elHighlight.addEventListener('change', renderOutput)
      document.querySelectorAll('.level-chip').forEach((btn) => {
        btn.addEventListener('click', () => {
          const level = btn.getAttribute('data-level')
          addConditionRow({ op: 'contains', val: level })
        })
      })
      document.getElementById('copy').addEventListener('click', async () => {
        const text = (window.__last || filtered || []).join('\n')
        try {
          await navigator.clipboard.writeText(text)
        } catch {}
      })
      document.getElementById('resetAll').addEventListener('click', () => {
        lines = []
        filtered = []
        filename = '—'
        elFile.value = ''
        document.getElementById('condList').innerHTML = ''
        editor.setValue("line => line.includes('ERROR')")
        elLimit.value = '500'
        renderOutput()
        updateMeta()
      })

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        const meta = e.ctrlKey || e.metaKey
        if (meta && e.key === 'Enter') {
          e.preventDefault()
          applyFilters()
        }
        if (meta && (e.key === 'Backspace' || e.key === 'Delete')) {
          e.preventDefault()
          document.getElementById('resetAll').click()
        }
      })

      // Export
      document.getElementById('export').addEventListener('click', () => {
        const result = window.__last || filtered || []
        if (!result.length) return
        const blob = new Blob([result.join('\n')], { type: 'text/plain;charset=utf-8;' })
        const url = URL.createObjectURL(blob)
        const a = document.createElement('a')
        a.href = url
        a.download = 'slice.log'
        a.click()
        URL.revokeObjectURL(url)
      })
    </script>
  </body>
</html>
