<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="author" content="Roman Merkulov"><meta http-equiv="X-UA-Compatible" content="chrome=1"><meta name="revisit-after" content="7 days"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="/favicon.svg" type="image/svg+xml"><link rel="alternate" type="application/rss+xml" title="Roman Merkulov's Blog" href="/feed.xml"><meta name="msapplication-TileColor" content="#ffffff"><title>Async, Sync, in Between</title><script>!function(){const e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,t=localStorage.getItem("vueuse-color-scheme")||"auto";("dark"===t||e&&"light"!==t)&&document.documentElement.classList.toggle("dark",!0)}()</script><script type="module" crossorigin="" src="/assets/app-BJ_3SEP9.js"></script><link rel="stylesheet" crossorigin="" href="/assets/app-BcEsbiLr.css"><link rel="modulepreload" crossorigin="" href="/assets/async-sync-in-between-CPhQpTJx.js"><meta property="og:title" content="Async, Sync, in Between"><meta name="twitter:title" content="Async, Sync, in Between"><meta name="description" content="The coloring problem in modern programming, and a proposal of a new approach"><meta property="og:description" content="The coloring problem in modern programming, and a proposal of a new approach"><meta name="twitter:description" content="The coloring problem in modern programming, and a proposal of a new approach"><meta property="og:image" content="https://romanmerk.me/og/async-sync-in-between.png"><meta name="twitter:image" content="https://romanmerk.me/og/async-sync-in-between.png"><meta name="twitter:card" content="summary_large_image"></head><body class="font-sans text-gray-700 dark:text-gray-200 relative"><div id="app" data-server-rendered="true"><!--[--><header class="header z-40" data-v-76b9d873=""><a href="/" class="w-100 h-100 absolute xl:fixed m-5 select-none outline-none" focusable="false" data-v-76b9d873=""><svg viewBox="0 0 800 200" fill="none" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Animated signature" data-v-76b9d873="" data-v-1ab25973=""><title data-v-1ab25973="">Roman Merkulov @ romanmerk.me</title><path shape-rendering="geometricPrecision" d="M 416,78 L 415,79 L 413,79 L 411,81 L 410,81 L 409,82 L 409,83 L 407,85 L 407,89 L 409,91 L 409,89 L 410,88 L 410,85 L 411,84 L 411,83 L 414,80 L 417,80 L 418,81 L 418,84 L 417,85 L 417,86 L 416,87 L 416,88 L 415,89 L 415,90 L 414,91 L 414,93 L 413,94 L 413,95 L 412,96 L 412,97 L 411,98 L 411,99 L 410,100 L 410,102 L 409,103 L 409,104 L 408,105 L 408,106 L 407,107 L 407,108 L 406,109 L 406,110 L 405,111 L 405,113 L 404,114 L 404,115 L 403,116 L 403,117 L 402,118 L 402,119 L 401,120 L 401,121 L 402,120 L 403,120 L 403,119 L 405,117 L 405,116 L 406,115 L 406,114 L 407,113 L 407,112 L 408,111 L 408,109 L 409,108 L 409,107 L 410,106 L 410,105 L 411,104 L 411,102 L 412,101 L 412,100 L 413,99 L 413,97 L 414,96 L 414,95 L 415,94 L 415,92 L 416,91 L 416,90 L 417,89 L 417,88 L 418,87 L 419,88 L 419,105 L 418,106 L 418,112 L 419,113 L 419,116 L 421,116 L 422,115 L 422,113 L 423,112 L 423,110 L 424,109 L 424,108 L 425,107 L 425,106 L 426,105 L 426,103 L 427,102 L 427,101 L 428,100 L 428,99 L 429,98 L 429,97 L 430,96 L 430,95 L 431,94 L 431,93 L 432,92 L 432,91 L 434,89 L 435,90 L 435,91 L 434,92 L 434,95 L 433,96 L 433,99 L 432,100 L 432,104 L 431,105 L 431,120 L 432,120 L 433,121 L 434,121 L 434,108 L 435,107 L 435,101 L 436,100 L 436,96 L 437,95 L 437,91 L 438,90 L 438,87 L 439,86 L 439,84 L 440,83 L 440,81 L 441,80 L 441,79 L 439,79 L 436,82 L 436,83 L 434,85 L 434,86 L 433,87 L 433,88 L 431,90 L 431,91 L 430,92 L 430,93 L 429,94 L 429,95 L 427,97 L 427,98 L 426,99 L 426,101 L 425,102 L 425,103 L 424,104 L 424,105 L 423,106 L 422,105 L 422,82 L 421,81 L 421,80 L 420,79 L 419,79 L 418,78 Z" data-v-1ab25973=""></path><path shape-rendering="geometricPrecision" d="M 372,78 L 371,79 L 368,79 L 367,80 L 365,80 L 364,81 L 363,81 L 363,82 L 365,82 L 366,81 L 367,81 L 368,80 L 370,80 L 371,79 L 372,80 L 372,81 L 371,82 L 371,83 L 370,84 L 370,85 L 369,86 L 369,88 L 368,89 L 368,90 L 367,91 L 367,93 L 366,94 L 366,95 L 365,96 L 365,98 L 364,99 L 364,101 L 363,102 L 363,104 L 362,105 L 362,107 L 361,108 L 361,110 L 360,111 L 360,113 L 359,114 L 359,116 L 358,117 L 358,119 L 360,121 L 361,121 L 361,120 L 362,119 L 362,117 L 363,116 L 363,113 L 364,112 L 364,109 L 365,108 L 365,106 L 366,105 L 366,103 L 367,102 L 368,103 L 368,105 L 369,106 L 369,107 L 370,108 L 370,109 L 372,111 L 372,112 L 373,113 L 373,114 L 375,116 L 375,117 L 378,120 L 378,121 L 379,121 L 381,123 L 382,123 L 383,122 L 384,122 L 384,121 L 375,112 L 375,111 L 373,109 L 373,108 L 371,106 L 371,105 L 370,104 L 370,103 L 368,101 L 368,100 L 369,99 L 376,99 L 377,98 L 379,98 L 380,97 L 381,97 L 382,96 L 383,96 L 387,92 L 387,90 L 388,89 L 388,87 L 387,86 L 387,84 L 383,80 L 381,80 L 380,79 L 377,79 L 376,78 Z" data-v-1ab25973=""></path></svg></a><button title="Scroll to top" fixed="" right-3="" bottom-3="" w-10="" h-10="" hover:op100="" rounded-full="" hover-bg-hex-8883="" transition="" duration-300="" z-100="" print:hidden="" class="op0! pointer-events-none" data-v-76b9d873=""><div i-ri-arrow-up-line="" data-v-76b9d873=""></div></button><nav class="nav" data-v-76b9d873=""><div class="spacer" data-v-76b9d873=""></div><div class="right" print:op0="" data-v-76b9d873=""><a href="/posts" class="router-link-active" title="Blog" data-v-76b9d873=""><span class="lt-md:hidden" data-v-76b9d873="">Blog</span><div i-ri-article-line="" md:hidden="" data-v-76b9d873=""></div></a><a href="/projects" class="" title="Projects" data-v-76b9d873=""><span class="lt-md:hidden" data-v-76b9d873="">Projects</span><div i-ri-lightbulb-line="" class="md:hidden" data-v-76b9d873=""></div></a><a href="/websites" class="" title="Websites" data-v-76b9d873=""><span class="lt-md:hidden" data-v-76b9d873="">Websites</span><div i-ri-links-line="" class="md:hidden" data-v-76b9d873=""></div></a><a href="/photos" class="" title="Photos" data-v-76b9d873=""><div i-ri-camera-3-line="" data-v-76b9d873=""></div></a><a href="/demos" class="" title="Demos" data-v-76b9d873=""><div i-ri-screenshot-line="" data-v-76b9d873=""></div></a><a href="https://github.com/R0KG" target="_blank" title="GitHub" class="lt-md:hidden" data-v-76b9d873=""><div i-uil-github-alt="" data-v-76b9d873=""></div></a><a class="select-none" title="Toggle Color Scheme" data-v-76b9d873=""><div i-ri-sun-line="" dark:i-ri-moon-line=""></div></a></div></nav></header><main class="px-7 py-10 of-x-hidden"><!--[--><!----><div lang="en" class="prose m-auto mb-8"><h1 class="mb-0 slide-enter-50">Async, Sync, in Between</h1><p class="opacity-50 !-mt-6 slide-enter-50">Mar 3 <span>· 18min</span></p><!----><!----><!----></div><article lang="en" class=""><!--[--><div class="prose m-auto slide-enter-content"><h2 id="the-coloring-problem" tabindex="-1">The Coloring Problem <a class="header-anchor" href="#the-coloring-problem" aria-hidden="true">#</a></h2><p>In modern programming, the function coloring problem isn’t new. Based on how functions execute: <code important-text-blue="">synchronous</code> (blocking) and <code important-text-rose="">asynchronous</code> (non-blocking), we often classify them into two "colors" for better distinction. The problem arises because you generally cannot mix and match these colors freely.</p><p>For instance, in JavaScript:</p><ul><li>An <span text-rose="">async</span> function can call both <span text-blue="">sync</span> and other <span text-rose="">async</span> functions.</li><li>A <span text-blue="">sync</span> function, however, cannot directly call an <span text-rose="">async</span> function without changing its own color to async.</li></ul><p>This restriction forces developers to propagate the "color" throughout their codebase. If a function deep in your logic needs to become async, it forces every caller up the chain to also become async, leading to a cascading effect (or "async inflection"). This makes refactoring harder, increases complexity, and sometimes leads to awkward workarounds like blocking async calls with await inside sync contexts, or vice versa.</p><figure><div flex="~ justify-center"><svg xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet" viewBox="0 0 600 240" select-none="" w-full=""><defs><!--[--><marker id="arrow-red" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse" fill="currentColor" class="stroke-current text-rose"><path d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker id="arrow-blue" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse" fill="currentColor" class="stroke-current text-blue"><path d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker id="arrow-purple" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse" fill="currentColor" class="stroke-current text-purple"><path d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker id="arrow-none" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse" fill="currentColor" class="stroke-current text-#ddd dark:text-#444"><path d="M 0 0 L 10 5 L 0 10 z"></path></marker><!--]--></defs><g><!--[--><path d="M23,20C23,45,33,45,33,70" fill="none" class="stroke-current text-#ddd dark:text-#444 transition-all duration-600"></path><path d="M33,70C33,95,43,95,43,120" fill="none" class="stroke-current text-#ddd dark:text-#444 transition-all duration-600"></path><path d="M43,120C43,145,53,145,53,170" fill="none" class="stroke-current text-#ddd dark:text-#444 transition-all duration-600"></path><path d="M53,170C53,195,63,195,63,220" fill="none" class="stroke-current text-#ddd dark:text-#444 transition-all duration-600"></path><path d="M323,20C323,45,333,45,333,70" fill="none" class="stroke-current text-rose:50 transition-all duration-600"></path><path d="M333,70C333,95,343,95,343,120" fill="none" class="stroke-current text-rose:50 transition-all duration-600"></path><path d="M343,120C343,145,353,145,353,170" fill="none" class="stroke-current text-rose:50 transition-all duration-600"></path><path d="M353,170C353,195,363,195,363,220" fill="none" class="stroke-current text-#ddd dark:text-#444 transition-all duration-600"></path><!--]--></g><g><!--[--><g><rect x="20" y="5" width="100" height="30" rx="8" ry="8" class="fill-#f8f8f8 dark:fill-#222 stroke-current text-#ddd dark:text-#444 transition-all duration-600"></rect><text x="70" y="20" font-family="monospace" text-anchor="middle" font-size="4" class="fill-#222 dark:fill-#eee transition-all duration-600" transform="translate(0, 5)">build()</text></g><g><rect x="30" y="55" width="140" height="30" rx="8" ry="8" class="fill-#f8f8f8 dark:fill-#222 stroke-current text-#ddd dark:text-#444 transition-all duration-600"></rect><text x="100" y="70" font-family="monospace" text-anchor="middle" font-size="4" class="fill-#222 dark:fill-#eee transition-all duration-600" transform="translate(0, 5)">transform()</text></g><g><rect x="40" y="105" width="100" height="30" rx="8" ry="8" class="fill-#f8f8f8 dark:fill-#222 stroke-current text-#ddd dark:text-#444 transition-all duration-600"></rect><text x="90" y="120" font-family="monospace" text-anchor="middle" font-size="4" class="fill-#222 dark:fill-#eee transition-all duration-600" transform="translate(0, 5)">parse()</text></g><g><rect x="50" y="155" width="130" height="30" rx="8" ry="8" class="fill-#f8f8f8 dark:fill-#222 stroke-current text-#ddd dark:text-#444 transition-all duration-600"></rect><text x="115" y="170" font-family="monospace" text-anchor="middle" font-size="4" class="fill-#222 dark:fill-#eee transition-all duration-600" transform="translate(0, 5)">loadFile()</text></g><g><rect x="60" y="205" width="120" height="30" rx="8" ry="8" class="fill-#f8f8f8 dark:fill-#222 stroke-current text-#ddd dark:text-#444 transition-all duration-600"></rect><text x="120" y="220" font-family="monospace" text-anchor="middle" font-size="4" class="fill-#222 dark:fill-#eee transition-all duration-600" transform="translate(0, 5)">replace()</text></g><g><rect x="320" y="5" width="160" height="30" rx="8" ry="8" class="fill-#fae3e6 dark:fill-#472127 stroke-current text-rose:50 transition-all duration-600"></rect><text x="400" y="20" font-family="monospace" text-anchor="middle" font-size="4" class="fill-rose transition-all duration-600" transform="translate(0, 5)">await build()</text></g><g><rect x="330" y="55" width="200" height="30" rx="8" ry="8" class="fill-#fae3e6 dark:fill-#472127 stroke-current text-rose:50 transition-all duration-600"></rect><text x="430" y="70" font-family="monospace" text-anchor="middle" font-size="4" class="fill-rose transition-all duration-600" transform="translate(0, 5)">await transform()</text></g><g><rect x="340" y="105" width="160" height="30" rx="8" ry="8" class="fill-#fae3e6 dark:fill-#472127 stroke-current text-rose:50 transition-all duration-600"></rect><text x="420" y="120" font-family="monospace" text-anchor="middle" font-size="4" class="fill-rose transition-all duration-600" transform="translate(0, 5)">await parse()</text></g><g><rect x="350" y="155" width="190" height="30" rx="8" ry="8" class="fill-#fae3e6 dark:fill-#472127 stroke-current text-rose:50 transition-all duration-600"></rect><text x="445" y="170" font-family="monospace" text-anchor="middle" font-size="4" class="fill-rose transition-all duration-600" transform="translate(0, 5)">await loadFile()</text></g><g><rect x="360" y="205" width="120" height="30" rx="8" ry="8" class="fill-#f8f8f8 dark:fill-#222 stroke-current text-#ddd dark:text-#444 transition-all duration-600"></rect><text x="420" y="220" font-family="monospace" text-anchor="middle" font-size="4" class="fill-#222 dark:fill-#eee transition-all duration-600" transform="translate(0, 5)">replace()</text></g><!--]--></g><g><!--[--><g><line x1="250" y1="140" x2="200" y2="160" stroke-width="2" class="stroke-current text-rose transition-all duration-600" marker-end="url(#arrow-red)"></line></g><!--]--></g><!--[--><!--]--></svg></div><figcaption text-center="">If `loadFile()` needs to be async, then all its callers upstream need to change to async too.</figcaption></figure><p>We often discuss the async inflection problem, where a common solution is to make everything async since async functions can call both sync and async functions, while the reverse is not true. However, the coloring problem actually goes both ways, which seems to be less frequently discussed:</p><p>While an async function requires all the <strong>callers</strong> to be async, a sync function also requires all the <strong>dependencies</strong> to be sync.</p><figure><div flex="~ justify-center"><svg xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet" viewBox="0 0 600 240" select-none="" w-full=""><defs><!--[--><marker id="arrow-red" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse" fill="currentColor" class="stroke-current text-rose"><path d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker id="arrow-blue" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse" fill="currentColor" class="stroke-current text-blue"><path d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker id="arrow-purple" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse" fill="currentColor" class="stroke-current text-purple"><path d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker id="arrow-none" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse" fill="currentColor" class="stroke-current text-#ddd dark:text-#444"><path d="M 0 0 L 10 5 L 0 10 z"></path></marker><!--]--></defs><g><!--[--><path d="M23,20C23,45,33,45,33,70" fill="none" class="stroke-current text-rose:50 transition-all duration-600"></path><path d="M33,70C33,95,43,95,43,120" fill="none" class="stroke-current text-rose:50 transition-all duration-600"></path><path d="M43,120C43,145,53,145,53,170" fill="none" class="stroke-current text-rose:50 transition-all duration-600"></path><path d="M53,170C53,195,63,195,63,220" fill="none" class="stroke-current text-#ddd dark:text-#444 transition-all duration-600"></path><path d="M323,20C323,45,333,45,333,70" fill="none" class="stroke-current text-rose:50 transition-all duration-600"></path><path d="M333,70C333,95,343,95,343,120" fill="none" class="stroke-current text-blue:50 transition-all duration-600"></path><path d="M343,120C343,145,353,145,353,170" fill="none" class="stroke-current text-blue:50 transition-all duration-600"></path><path d="M353,170C353,195,363,195,363,220" fill="none" class="stroke-current text-blue:50 transition-all duration-600"></path><!--]--></g><g><!--[--><g><rect x="20" y="5" width="160" height="30" rx="8" ry="8" class="fill-#fae3e6 dark:fill-#472127 stroke-current text-rose:50 transition-all duration-600"></rect><text x="100" y="20" font-family="monospace" text-anchor="middle" font-size="4" class="fill-rose transition-all duration-600" transform="translate(0, 5)">await build()</text></g><g><rect x="30" y="55" width="200" height="30" rx="8" ry="8" class="fill-#fae3e6 dark:fill-#472127 stroke-current text-rose:50 transition-all duration-600"></rect><text x="130" y="70" font-family="monospace" text-anchor="middle" font-size="4" class="fill-rose transition-all duration-600" transform="translate(0, 5)">await transform()</text></g><g><rect x="40" y="105" width="160" height="30" rx="8" ry="8" class="fill-#fae3e6 dark:fill-#472127 stroke-current text-rose:50 transition-all duration-600"></rect><text x="120" y="120" font-family="monospace" text-anchor="middle" font-size="4" class="fill-rose transition-all duration-600" transform="translate(0, 5)">await parse()</text></g><g><rect x="50" y="155" width="190" height="30" rx="8" ry="8" class="fill-#fae3e6 dark:fill-#472127 stroke-current text-rose:50 transition-all duration-600"></rect><text x="145" y="170" font-family="monospace" text-anchor="middle" font-size="4" class="fill-rose transition-all duration-600" transform="translate(0, 5)">await loadFile()</text></g><g><rect x="60" y="205" width="120" height="30" rx="8" ry="8" class="fill-#f8f8f8 dark:fill-#222 stroke-current text-#ddd dark:text-#444 transition-all duration-600"></rect><text x="120" y="220" font-family="monospace" text-anchor="middle" font-size="4" class="fill-#222 dark:fill-#eee transition-all duration-600" transform="translate(0, 5)">replace()</text></g><g><rect x="320" y="5" width="160" height="30" rx="8" ry="8" class="fill-#fae3e6 dark:fill-#472127 stroke-current text-rose:50 transition-all duration-600"></rect><text x="400" y="20" font-family="monospace" text-anchor="middle" font-size="4" class="fill-rose transition-all duration-600" transform="translate(0, 5)">await build()</text></g><g><rect x="330" y="55" width="200" height="30" rx="8" ry="8" class="fill-#fae3e6 dark:fill-#472127 stroke-current text-rose:50 transition-all duration-600"></rect><text x="430" y="70" font-family="monospace" text-anchor="middle" font-size="4" class="fill-rose transition-all duration-600" transform="translate(0, 5)">await transform()</text></g><g><rect x="340" y="105" width="140" height="30" rx="8" ry="8" class="fill-#e0f2fe dark:fill-#192a59 stroke-current text-blue:50 transition-all duration-600"></rect><text x="410" y="120" font-family="monospace" text-anchor="middle" font-size="4" class="fill-blue transition-all duration-600" transform="translate(0, 5)">parseSync()</text></g><g><rect x="350" y="155" width="170" height="30" rx="8" ry="8" class="fill-#e0f2fe dark:fill-#192a59 stroke-current text-blue:50 transition-all duration-600"></rect><text x="435" y="170" font-family="monospace" text-anchor="middle" font-size="4" class="fill-blue transition-all duration-600" transform="translate(0, 5)">loadFileSync()</text></g><g><rect x="360" y="205" width="120" height="30" rx="8" ry="8" class="fill-#e0f2fe dark:fill-#192a59 stroke-current text-blue:50 transition-all duration-600"></rect><text x="420" y="220" font-family="monospace" text-anchor="middle" font-size="4" class="fill-blue transition-all duration-600" transform="translate(0, 5)">replace()</text></g><!--]--></g><g><!--[--><g><line x1="270" y1="100" x2="215" y2="115" stroke-width="2" class="stroke-current text-blue transition-all duration-600" marker-end="url(#arrow-blue)"></line></g><!--]--></g><!--[--><!--]--></svg></div><figcaption text-center="">If `parse()` needs to be sync, then all its dependencies down the road need to be sync too.</figcaption></figure><p>At its core, it’s the same problem with different perspectives. It depends on which part of the code you’re focusing on and how difficult it is to change its "color." If the function you’re working on <strong>must be async</strong>, the burden shifts to the callers. Conversely, if it <strong>must be sync</strong>, you’ll need all your dependencies to be sync or provide a synchronous entry point.</p><h3 id="libraries-in-practice" tabindex="-1">Libraries in Practice <a class="header-anchor" href="#libraries-in-practice" aria-hidden="true">#</a></h3><p>For example, the widely used library <a href="https://github.com/sindresorhus/find-up" target="_blank" rel="noopener"><code>find-up</code></a> provides two main APIs, <code important-text-rose="">findUp</code> and <code important-text-blue="">findUpSync</code>, to avoid dependents being trapped by the coloring problem. If you look into the code, you’ll find that the package essentially <a href="https://github.com/sindresorhus/find-up/blob/b733bb70d3aa21b22fa011be8089110d467c317f/index.js#L51" target="_blank" rel="noopener">duplicates the logic twice</a> to provide the two APIs. Going down, you see its dependency <a href="https://github.com/sindresorhus/locate-path" target="_blank" rel="noopener"><code>locate-path</code></a> also <a href="https://github.com/sindresorhus/locate-path/blob/355a681456d79a8506de11120d56b6e34a0389b5/index.js#L49" target="_blank" rel="noopener">duplicates the <code important-text-rose="">locatePath</code> and <code important-text-blue="">locatePathSync</code> logic</a>.</p><p>Say you want to build another library that uses <code>findUp</code>, like <code>readNearestPkg</code>, you would also have to write the logic twice, using <code important-text-rose="">findUp</code> and <code important-text-blue="">findUpSync</code> separately, to support both async and sync usage.</p><p>In these cases, even if our main logic does not come with its own "colors," the whole dependency pipeline is forced to branch into two colors due to an optional async operation down the road (e.g., <code important-text-rose="">fs.promises.stat</code> and <code important-text-blue="">fs.statSync</code>).</p><figure><div flex="~ justify-center"><svg xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet" viewBox="0 0 580 400" select-none="" w-full=""><defs><!--[--><marker id="arrow-red" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse" fill="currentColor" class="stroke-current text-rose"><path d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker id="arrow-blue" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse" fill="currentColor" class="stroke-current text-blue"><path d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker id="arrow-purple" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse" fill="currentColor" class="stroke-current text-purple"><path d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker id="arrow-none" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse" fill="currentColor" class="stroke-current text-#ddd dark:text-#444"><path d="M 0 0 L 10 5 L 0 10 z"></path></marker><!--]--></defs><g><!--[--><path d="M73,50C73,90,83,90,83,130" fill="none" class="stroke-current text-rose:50 transition-all duration-600"></path><path d="M83,130C83,170,93,170,93,210" fill="none" class="stroke-current text-rose:50 transition-all duration-600"></path><path d="M93,210C93,250,103,250,103,290" fill="none" class="stroke-current text-rose:50 transition-all duration-600"></path><path d="M103,290C103,330,113,330,113,370" fill="none" class="stroke-current text-rose:50 transition-all duration-600"></path><path d="M303,50C303,90,313,90,313,130" fill="none" class="stroke-current text-blue:50 transition-all duration-600"></path><path d="M313,130C313,170,323,170,323,210" fill="none" class="stroke-current text-blue:50 transition-all duration-600"></path><path d="M323,210C323,250,333,250,333,290" fill="none" class="stroke-current text-blue:50 transition-all duration-600"></path><path d="M333,290C333,330,343,330,343,370" fill="none" class="stroke-current text-blue:50 transition-all duration-600"></path><!--]--></g><g><!--[--><g><rect x="70" y="35" width="200" height="30" rx="8" ry="8" class="fill-#fae3e6 dark:fill-#472127 stroke-current text-rose:50 transition-all duration-600"></rect><text x="170" y="50" font-family="monospace" text-anchor="middle" font-size="4" class="fill-rose transition-all duration-600" transform="translate(0, 5)">[async consumers]</text></g><g><rect x="80" y="115" width="190" height="30" rx="8" ry="8" class="fill-#fae3e6 dark:fill-#472127 stroke-current text-rose:50 transition-all duration-600"></rect><text x="175" y="130" font-family="monospace" text-anchor="middle" font-size="4" class="fill-rose transition-all duration-600" transform="translate(0, 5)">readNearestPkg()</text></g><g><rect x="90" y="195" width="110" height="30" rx="8" ry="8" class="fill-#fae3e6 dark:fill-#472127 stroke-current text-rose:50 transition-all duration-600"></rect><text x="145" y="210" font-family="monospace" text-anchor="middle" font-size="4" class="fill-rose transition-all duration-600" transform="translate(0, 5)">findUp()</text></g><g><rect x="100" y="275" width="150" height="30" rx="8" ry="8" class="fill-#fae3e6 dark:fill-#472127 stroke-current text-rose:50 transition-all duration-600"></rect><text x="175" y="290" font-family="monospace" text-anchor="middle" font-size="4" class="fill-rose transition-all duration-600" transform="translate(0, 5)">locatePath()</text></g><g><rect x="110" y="355" width="120" height="30" rx="8" ry="8" class="fill-#fae3e6 dark:fill-#472127 stroke-current text-rose:50 transition-all duration-600"></rect><text x="170" y="370" font-family="monospace" text-anchor="middle" font-size="4" class="fill-rose transition-all duration-600" transform="translate(0, 5)">fs.stat()</text></g><g><rect x="300" y="35" width="190" height="30" rx="8" ry="8" class="fill-#e0f2fe dark:fill-#192a59 stroke-current text-blue:50 transition-all duration-600"></rect><text x="395" y="50" font-family="monospace" text-anchor="middle" font-size="4" class="fill-blue transition-all duration-600" transform="translate(0, 5)">[sync consumers]</text></g><g><rect x="310" y="115" width="230" height="30" rx="8" ry="8" class="fill-#e0f2fe dark:fill-#192a59 stroke-current text-blue:50 transition-all duration-600"></rect><text x="425" y="130" font-family="monospace" text-anchor="middle" font-size="4" class="fill-blue transition-all duration-600" transform="translate(0, 5)">readNearestPkgSync()</text></g><g><rect x="320" y="195" width="150" height="30" rx="8" ry="8" class="fill-#e0f2fe dark:fill-#192a59 stroke-current text-blue:50 transition-all duration-600"></rect><text x="395" y="210" font-family="monospace" text-anchor="middle" font-size="4" class="fill-blue transition-all duration-600" transform="translate(0, 5)">findUpSync()</text></g><g><rect x="330" y="275" width="190" height="30" rx="8" ry="8" class="fill-#e0f2fe dark:fill-#192a59 stroke-current text-blue:50 transition-all duration-600"></rect><text x="425" y="290" font-family="monospace" text-anchor="middle" font-size="4" class="fill-blue transition-all duration-600" transform="translate(0, 5)">locatePathSync()</text></g><g><rect x="340" y="355" width="160" height="30" rx="8" ry="8" class="fill-#e0f2fe dark:fill-#192a59 stroke-current text-blue:50 transition-all duration-600"></rect><text x="420" y="370" font-family="monospace" text-anchor="middle" font-size="4" class="fill-blue transition-all duration-600" transform="translate(0, 5)">fs.statSync()</text></g><!--]--></g><g><!--[--><!--]--></g><!--[--><!--[--><g><text x="10" y="105" font-family="monospace" font-size="4" class="fill-purple">my-pkg</text><rect x="0" y="100" width="560" height="60" rx="10" ry="10" stroke-dasharray="4 2" class="fill-none stroke-purple:50"></rect></g><g><text x="10" y="185" font-family="monospace" font-size="4" class="fill-purple">find-up</text><rect x="0" y="180" width="560" height="60" rx="10" ry="10" stroke-dasharray="4 2" class="fill-none stroke-purple:50"></rect></g><g><text x="10" y="265" font-family="monospace" font-size="4" class="fill-purple">locate-path</text><rect x="0" y="260" width="560" height="60" rx="10" ry="10" stroke-dasharray="4 2" class="fill-none stroke-purple:50"></rect></g><!--]--><!--]--></svg></div><figcaption text-center="">Basically, we would maintain two branches of code to support both sync and async, with only a few sync utils that can be shared.</figcaption></figure><h3 id="async-plugins" tabindex="-1">Async Plugins <a class="header-anchor" href="#async-plugins" aria-hidden="true">#</a></h3><p>Another case demonstrating the coloring problem is a plugin system with async hooks. For example, imagine we are building a Markdown-to-HTML compiler with plugin support. Say the parser and compiler logic are synchronous; we could expose a sync API like:</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-ts"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> function</span><span style="--s-dark:#80A665;--s-light:#59873A"> markdownToHtml</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">markdown</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">ast</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> parse</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">markdown</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ...</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  return</span><span style="--s-dark:#80A665;--s-light:#59873A"> render</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">ast</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>To make our library extensible, we might allow plugins to register hooks at multiple stages thoughout the process, for example:</p><pre class="shiki shiki-themes vitesse-dark vitesse-light has-highlighted" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-ts"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> interface</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> Plugin</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  preprocess</span><span style="--s-dark:#666666;--s-light:#999999">: (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">markdown</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">string</span><span style="--s-dark:#666666;--s-light:#999999">) =&gt; </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">string</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  transform</span><span style="--s-dark:#666666;--s-light:#999999">: (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">ast</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">AST</span><span style="--s-dark:#666666;--s-light:#999999">) =&gt; </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">AST</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  postprocess</span><span style="--s-dark:#666666;--s-light:#999999">: (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">html</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">string</span><span style="--s-dark:#666666;--s-light:#999999">) =&gt; </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">string</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> function</span><span style="--s-dark:#80A665;--s-light:#59873A"> markdownToHtml</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">markdown</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> plugins</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  for</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">plugin</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> of</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> plugins</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line highlighted"><span style="--s-dark:#BD976A;--s-light:#B07D48">    markdown</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> plugin</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">preprocess</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">markdown</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  let </span><span style="--s-dark:#BD976A;--s-light:#B07D48">ast</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> parse</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">markdown</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  for</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">plugin</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> of</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> plugins</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line highlighted"><span style="--s-dark:#BD976A;--s-light:#B07D48">    ast</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> plugin</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">transform</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">ast</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  let </span><span style="--s-dark:#BD976A;--s-light:#B07D48">html</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> render</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">ast</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  for</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">plugin</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> of</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> plugins</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line highlighted"><span style="--s-dark:#BD976A;--s-light:#B07D48">    html</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> plugin</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">postprocess</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">html</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> html</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>Great, now we have a plugin system. However, having <code>markdownToHtml</code> as a synchronous function essentially limits all plugin hooks to be synchronous as well. This limitation can be quite restrictive. For instance, consider a plugin for syntax highlighting. In many cases, the best results for syntax highlighting might require asynchronous operations, such as fetching additional resources or performing complex computations that are better suited for non-blocking execution.</p><p>To accommodate such scenarios, we need to allow <span text-rose="">async hooks</span> in our plugin system. This means that our main function, <code>markdownToHtml</code>, as the caller of the plugin hooks must also be async. We could implement it like this:</p><pre class="shiki shiki-themes vitesse-dark vitesse-light has-highlighted" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-ts"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> interface</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> Plugin</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  preprocess</span><span style="--s-dark:#666666;--s-light:#999999">: (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">markdown</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">string</span><span style="--s-dark:#666666;--s-light:#999999">) =&gt; </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">string</span><span style="--s-dark:#666666;--s-light:#999999"> | </span><span style="--s-dark:#5DA994;--s-light:#2E8F82" class="highlighted-word">Promise</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">string</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  transform</span><span style="--s-dark:#666666;--s-light:#999999">: (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">ast</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">AST</span><span style="--s-dark:#666666;--s-light:#999999">) =&gt; </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">AST</span><span style="--s-dark:#666666;--s-light:#999999"> | </span><span style="--s-dark:#5DA994;--s-light:#2E8F82" class="highlighted-word">Promise</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">AST</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  postprocess</span><span style="--s-dark:#666666;--s-light:#999999">: (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">html</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">string</span><span style="--s-dark:#666666;--s-light:#999999">) =&gt; </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">string</span><span style="--s-dark:#666666;--s-light:#999999"> | </span><span style="--s-dark:#5DA994;--s-light:#2E8F82" class="highlighted-word">Promise</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">string</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> </span><span style="--s-dark:#CB7676;--s-light:#AB5959" class="highlighted-word">async</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> function</span><span style="--s-dark:#80A665;--s-light:#59873A"> markdownToHtml</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">markdown</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> plugins</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  for</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">plugin</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> of</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> plugins</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line highlighted"><span style="--s-dark:#BD976A;--s-light:#B07D48">    markdown</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> </span><span style="--s-dark:#4D9375;--s-light:#1E754F" class="highlighted-word">await</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> plugin</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">preprocess</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">markdown</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  let </span><span style="--s-dark:#BD976A;--s-light:#B07D48">ast</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> parse</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">markdown</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  for</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">plugin</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> of</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> plugins</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line highlighted"><span style="--s-dark:#BD976A;--s-light:#B07D48">    ast</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> </span><span style="--s-dark:#4D9375;--s-light:#1E754F" class="highlighted-word">await</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> plugin</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">transform</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">ast</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  let </span><span style="--s-dark:#BD976A;--s-light:#B07D48">html</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> render</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">ast</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  for</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">plugin</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> of</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> plugins</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line highlighted"><span style="--s-dark:#BD976A;--s-light:#B07D48">    html</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> </span><span style="--s-dark:#4D9375;--s-light:#1E754F" class="highlighted-word">await</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> plugin</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">postprocess</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">html</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> html</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>While this maximized the flexibility of the plugin system, this approach also <strong>forces</strong> all users to handle the process <span text-rose="">asynchronously</span>, even in the cases where all plugins are synchronous. This is the cost of accommodating the possibility that some operations "<b important-text-purple="">might be asynchronous</b>". To manage this, we often end up duplicating the logic to offer both sync and async APIs, and restrict async plugins to the async version only.</p><p>Such duplications lead to increased maintenance efforts, potential inconsistencies, and larger bundle sizes, which are not ideal for maintainers or users.</p><p>Is there a better way to handle this?</p><h2 id="introducing-quansync" tabindex="-1">Introducing Quansync <a class="header-anchor" href="#introducing-quansync" aria-hidden="true">#</a></h2><p>What if we could make our logic decoupled from the coloring problem and let the caller decide the color?</p><p>Trying to make the situation a bit better, <a href="https://github.com/sxzz" class="markdown-magic-link markdown-magic-link-github-at" target="_blank" rel="noopener"><span class="markdown-magic-link-image" style="background-image:url('https://github.com/sxzz.png')"></span>SXZZ</a> and I took inspiration from <a href="https://github.com/loganfsmyth/gensync" target="_blank" rel="noopener"><code>gensync</code></a> by <a href="https://github.com/loganfsmyth" class="markdown-magic-link markdown-magic-link-github-at" target="_blank" rel="noopener"><span class="markdown-magic-link-image" style="background-image:url('https://github.com/loganfsmyth.png')"></span>LOGANFSMYTH</a> and made a package called <a href="https://github.com/antfu-collective/quansync" target="_blank" rel="noopener"><code important-text-purple="">quansync</code></a>. Taking it even further, we are dreaming of leveraging this to create a paradigm shift in the way we write libraries in the JavaScript ecosystem.</p><p>The name <code important-text-purple="">Quansync</code> is borrowed from <a href="https://en.wikipedia.org/wiki/Quantum_mechanics" target="_blank" rel="noopener">Quantum Mechanics</a>, where particles can exist in multiple states simultaneously, known as <em>superposition</em>, and only settle into a single state when observed <span op50="">(try hovering over the atom below)</span>.</p><div py10="" flex="~ items-center justify-center col md:row md:justify-between" text-center=""><div><b>Quan</b><span op75="">tum</span> + <b><span class="op0" transition="" duration-1000="">a</span>Sync</b></div><div flex="~" select-none="" my--4=""><canvas ma="" transition-all="" duration-300="" width="250" height="250" class="blur-1px"></canvas></div><div op75=""><em transition-all="" duration-1000="" class="text-purple!">"Superposition"</em><br>between <code important-text-sky="" transition-all="" duration-1000="" class="">sync</code> and <code important-text-rose="" transition-all="" duration-1000="" class="">async</code></div></div><p>You can think of <code important-text-purple="">quansync</code> as a new type of function that can be used as both <code important-text-blue="">sync</code> and <code important-text-rose="">async</code> depending on the context. In many cases, our logic can escape the async inflection problem, especially when designing shared logic with optional async hooks.</p><figure><div flex="~ justify-center"><svg xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet" viewBox="0 0 600 450" select-none="" w-full=""><defs><!--[--><marker id="arrow-red" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse" fill="currentColor" class="stroke-current text-rose"><path d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker id="arrow-blue" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse" fill="currentColor" class="stroke-current text-blue"><path d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker id="arrow-purple" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse" fill="currentColor" class="stroke-current text-purple"><path d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker id="arrow-none" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse" fill="currentColor" class="stroke-current text-#ddd dark:text-#444"><path d="M 0 0 L 10 5 L 0 10 z"></path></marker><!--]--></defs><g><!--[--><path d="M180,20C180,70,290,70,290,120" fill="none" class="stroke-current text-purple:50 transition-all duration-600"></path><path d="M405,20C405,70,290,70,290,120" fill="none" class="stroke-current text-purple:50 transition-all duration-600"></path><path d="M290,120C290,150,290,150,290,180" fill="none" class="stroke-current text-purple:50 transition-all duration-600"></path><path d="M290,180C290,210,290,210,290,240" fill="none" class="stroke-current text-purple:50 transition-all duration-600"></path><path d="M290,240C290,270,290,270,290,300" fill="none" class="stroke-current text-purple:50 transition-all duration-600"></path><path d="M290,300C290,350,380,350,380,400" fill="none" class="stroke-current text-rose:50 transition-all duration-600"></path><path d="M290,300C290,350,200,350,200,400" fill="none" class="stroke-current text-blue:50 transition-all duration-600"></path><!--]--></g><g><!--[--><g><rect x="80" y="5" width="200" height="30" rx="8" ry="8" class="fill-#fae3e6 dark:fill-#472127 stroke-current text-rose:50 transition-all duration-600"></rect><text x="180" y="20" font-family="monospace" text-anchor="middle" font-size="4" class="fill-rose transition-all duration-600" transform="translate(0, 5)">[async consumers]</text></g><g><rect x="310" y="5" width="190" height="30" rx="8" ry="8" class="fill-#e0f2fe dark:fill-#192a59 stroke-current text-blue:50 transition-all duration-600"></rect><text x="405" y="20" font-family="monospace" text-anchor="middle" font-size="4" class="fill-blue transition-all duration-600" transform="translate(0, 5)">[sync consumers]</text></g><g><rect x="190" y="105" width="200" height="30" rx="8" ry="8" class="fill-#f5f3ff dark:fill-#271347 stroke-current text-purple:50 transition-all duration-600"></rect><text x="290" y="120" font-family="monospace" text-anchor="middle" font-size="4" class="fill-purple transition-all duration-600" transform="translate(0, 5)">*readNearestPkg()</text></g><g><rect x="230" y="165" width="120" height="30" rx="8" ry="8" class="fill-#f5f3ff dark:fill-#271347 stroke-current text-purple:50 transition-all duration-600"></rect><text x="290" y="180" font-family="monospace" text-anchor="middle" font-size="4" class="fill-purple transition-all duration-600" transform="translate(0, 5)">*findUp()</text></g><g><rect x="210" y="225" width="160" height="30" rx="8" ry="8" class="fill-#f5f3ff dark:fill-#271347 stroke-current text-purple:50 transition-all duration-600"></rect><text x="290" y="240" font-family="monospace" text-anchor="middle" font-size="4" class="fill-purple transition-all duration-600" transform="translate(0, 5)">*locatePath()</text></g><g><rect x="240" y="285" width="100" height="30" rx="8" ry="8" class="fill-#f5f3ff dark:fill-#271347 stroke-current text-purple:50 transition-all duration-600"></rect><text x="290" y="300" font-family="monospace" text-anchor="middle" font-size="4" class="fill-purple transition-all duration-600" transform="translate(0, 5)">*stat()</text></g><g><rect x="320" y="385" width="120" height="30" rx="8" ry="8" class="fill-#fae3e6 dark:fill-#472127 stroke-current text-rose:50 transition-all duration-600"></rect><text x="380" y="400" font-family="monospace" text-anchor="middle" font-size="4" class="fill-rose transition-all duration-600" transform="translate(0, 5)">fs.stat()</text></g><g><rect x="120" y="385" width="160" height="30" rx="8" ry="8" class="fill-#e0f2fe dark:fill-#192a59 stroke-current text-blue:50 transition-all duration-600"></rect><text x="200" y="400" font-family="monospace" text-anchor="middle" font-size="4" class="fill-blue transition-all duration-600" transform="translate(0, 5)">fs.statSync()</text></g><!--]--></g><g><!--[--><!--]--></g><!--[--><!--]--></svg></div><figcaption text-center="">Try hovering over either the async or sync side.<br>Quansync functions are in purple, which can adapt to either sync or async.</figcaption></figure><h3 id="usage-examples" tabindex="-1">Usage Examples <a class="header-anchor" href="#usage-examples" aria-hidden="true">#</a></h3><p>Quansync provides a single API with two overloads.</p><h4 id="wrapper-api" tabindex="-1">Wrapper API <a class="header-anchor" href="#wrapper-api" aria-hidden="true">#</a></h4><p>Wrapper allows you to create a quansync function by providing a sync and an async implementation. For example:</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-ts"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">import</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> fs</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> from</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959">find-up</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">import</span><span style="--s-dark:#666666;--s-light:#999999"> {</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> quansync</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> from</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959">quansync</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">readFile</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> quansync</span><span style="--s-dark:#666666;--s-light:#999999">({</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  sync</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#BD976A;--s-light:#B07D48">filepath</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt; </span><span style="--s-dark:#BD976A;--s-light:#B07D48">fs</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">readFileSync</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">filepath</span><span style="--s-dark:#666666;--s-light:#999999">),</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  async</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#BD976A;--s-light:#B07D48">filepath</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt; </span><span style="--s-dark:#BD976A;--s-light:#B07D48">fs</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">promises</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">readFile</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">filepath</span><span style="--s-dark:#666666;--s-light:#999999">),</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">})</span></span></code></pre><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-ts"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">content1</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> readFile</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">sync</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959">package.json</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">content2</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> await</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> readFile</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">async</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959">package.json</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// The quansync function itself can behave like a normal async function</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">content3</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> await</span><span style="--s-dark:#80A665;--s-light:#59873A"> readFile</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959">package.json</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span></code></pre><h4 id="generator-api" tabindex="-1">Generator API <a class="header-anchor" href="#generator-api" aria-hidden="true">#</a></h4><p>Generator is where the magic happens. It allows you to create a <code>quansync</code> function by using other <code>quansync</code> functions. For example:</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-ts"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">import</span><span style="--s-dark:#666666;--s-light:#999999"> {</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> quansync</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> from</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959">quansync</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">readFile</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> quansync</span><span style="--s-dark:#666666;--s-light:#999999">({</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  sync</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#BD976A;--s-light:#B07D48">filepath</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt; </span><span style="--s-dark:#BD976A;--s-light:#B07D48">fs</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">readFileSync</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">filepath</span><span style="--s-dark:#666666;--s-light:#999999">),</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  async</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#BD976A;--s-light:#B07D48">filepath</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt; </span><span style="--s-dark:#BD976A;--s-light:#B07D48">fs</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">promises</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">readFile</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">filepath</span><span style="--s-dark:#666666;--s-light:#999999">),</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">})</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// Create a quansync with `function*` and `yield*`</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">readJSON</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> quansync</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#CB7676;--s-light:#AB5959" class="highlighted-word">function</span><span style="--s-dark:#4D9375;--s-light:#1E754F" class="highlighted-word">*</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">filepath</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // Call the quansync function directly</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // and use `yield*` to get the result.</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // Upon usage, it will auto select the implementation</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">content</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> </span><span style="--s-dark:#4D9375;--s-light:#1E754F" class="highlighted-word">yield*</span><span style="--s-dark:#80A665;--s-light:#59873A"> readFile</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">filepath</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> JSON</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">parse</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">content</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">})</span></span></code></pre><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-ts"><span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// fs.readFileSync will be used under the hood</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">pkg1</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> readJSON</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">sync</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959">package.json</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// fs.promises.readFile will be used under the hood</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">pkg2</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> await</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> readJSON</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">async</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959">package.json</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span></code></pre><h3 id="build-time-macros" tabindex="-1">Build-time Macros <a class="header-anchor" href="#build-time-macros" aria-hidden="true">#</a></h3><p>If the <code>function*</code> and <code>yield*</code> syntax scares you a bit, <a href="https://github.com/sxzz" class="markdown-magic-link markdown-magic-link-github-at" target="_blank" rel="noopener"><span class="markdown-magic-link-image" style="background-image:url('https://github.com/sxzz.png')"></span>SXZZ</a> also made a build-time macro <a href="https://github.com/quansync-dev/unplugin-quansync" target="_blank" rel="noopener"><code>unplugin-quansync</code></a> allowing you to write normal <code>async</code>/<code>await</code> syntax, and it will be transformed to the corresponding <code>yield*</code> syntax at build time.</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-ts"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">import</span><span style="--s-dark:#666666;--s-light:#999999"> {</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> quansync</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> from</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959" class="highlighted-word">quansync/macro</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// Use async/await syntax</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// They will be transformed to `function*` and `yield*` at build time</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">readJSON</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> quansync</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#CB7676;--s-light:#AB5959">async </span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">filepath</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">content</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> await</span><span style="--s-dark:#80A665;--s-light:#59873A"> readFile</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">filepath</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> JSON</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">parse</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">content</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">})</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// Expose the classical sync API</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">readJSONSync</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> readJSON</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">sync</span></span></code></pre><p>Thanks to <a href="https://github.com/unjs/unplugin" target="_blank" rel="noopener"><code>unplugin</code></a>, it can work in almost any build tool, like compiling with <code>unbuild</code> or testing with <code>vitest</code>. Please refer to <a href="https://github.com/quansync-dev/unplugin-quansync" target="_blank" rel="noopener">the docs</a> for more detailed setup.</p><h2 id="how-does-it-work" tabindex="-1">How does it Work? <a class="header-anchor" href="#how-does-it-work" aria-hidden="true">#</a></h2><p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Generator" target="_blank" rel="noopener">Generators</a> in JavaScript are a powerful yet often underutilized feature. To define a generator function, you use the <code>function*</code> syntax (note that arrow functions do not support generators). Inside a generator function, you can use the <code>yield</code> keyword to pause execution and return a value. This effectively splits your logic into multiple "chunks," allowing the caller to control when to execute the next chunk.</p><p>By leveraging this behavior, we can pause execution at each <code>yield</code> point. In an asynchronous context, we can wait for the async operation to complete before resuming execution. In a synchronous context, the next chunk runs immediately. This approach offloads the coloring problem to the caller, allowing them to decide whether the function should run synchronously or asynchronously.</p><p>In fact, during the early days of JavaScript, before the <code>async</code> and <code>await</code> keywords were widely adopted, Babel used generators and <code>yield</code> to polyfill async behavior. While this technique isn’t new, we believe it has significant potential to improve how we handle the coloring problem, especially in library design.</p><h2 id="when-not-to-use" tabindex="-1">When not to Use? <a class="header-anchor" href="#when-not-to-use" aria-hidden="true">#</a></h2><p>Frankly, I wish most of time you don’t even need to think about it. High-level tools should support async entry points for most cases, where choice <code>sync</code> and <code>async</code> is not a problem. However, there are still many cases where in the context, it’s required to be colored. In such cases, <code>quansync</code> could be a good fit for progressive and gradual adoption.</p><p>Promise in JavaScript naturally a <a href="https://javascript.info/event-loop" target="_blank" rel="noopener">microtask</a> that delays a tick. <code>yield</code> also introduce certain overhead (<a href="https://github.com/quansync-dev/quansync#benchmark" target="_blank" rel="noopener">around <code>~120ns</code> on M1 Max</a>). In performance-sensitive scenarios, you might also want to avoid using either <code>async</code>or <code>quansync</code>.</p><h2 id="coloring-problem-revisited" tabindex="-1">Coloring Problem Revisited <a class="header-anchor" href="#coloring-problem-revisited" aria-hidden="true">#</a></h2><p>While <code>quansync</code> doesn’t completely solve the coloring problem, it provides a new perspective that simplifies managing synchronous and asynchronous code. Quansync introduces a new <span text-purple="">"purple"</span> color, blending the red and blue. Quansync functions still face the coloring problem, as wrapping a function to support both sync and async requires it to be a quansync function (or generator). However, the key advantage is that a quansync function can be <a href="https://en.wikipedia.org/wiki/Wave_function_collapse" target="_blank" rel="noopener">"collapsed"</a> to either sync or async as needed. This allows your "colorless" logic to avoid the red and blue color inflection caused by some operations that might have a color.</p><h2 id="conclusion" tabindex="-1">Conclusion <a class="header-anchor" href="#conclusion" aria-hidden="true">#</a></h2><p>This is a new approach to tackling the coloring problem we are still exploring. We will slowly roll out <code>quansync</code> in our libraries and see how it improves our experience and the ecosystem. We are also looking for feedback and contributions, so feel free to join us in the <a href="https://chat.antfu.me" target="_blank" rel="noopener">Discord</a> or <a href="https://github.com/quansync-dev/quansync/discussions" target="_blank" rel="noopener">GitHub Discussions</a> to share your thoughts.</p><ul><li><span ws-nowrap=""><svg style="vertical-align:sub" class="inline inline-block" viewBox="0 0 32 32" width="1.2em" height="1.2em"><path fill="currentColor" fill-rule="evenodd" d="M16 2a14 14 0 0 0-4.43 27.28c.7.13 1-.3 1-.67v-2.38c-3.89.84-4.71-1.88-4.71-1.88a3.7 3.7 0 0 0-1.62-2.05c-1.27-.86.1-.85.1-.85a2.94 2.94 0 0 1 2.14 1.45a3 3 0 0 0 4.08 1.16a2.93 2.93 0 0 1 .88-1.87c-3.1-.36-6.37-1.56-6.37-6.92a5.4 5.4 0 0 1 1.44-3.76a5 5 0 0 1 .14-3.7s1.17-.38 3.85 1.43a13.3 13.3 0 0 1 7 0c2.67-1.81 3.84-1.43 3.84-1.43a5 5 0 0 1 .14 3.7a5.4 5.4 0 0 1 1.44 3.76c0 5.38-3.27 6.56-6.39 6.91a3.33 3.33 0 0 1 .95 2.59v3.84c0 .46.25.81 1 .67A14 14 0 0 0 16 2"></path></svg><a class="opacity-70 ml-1 font-mono" href="https://github.com/quansync-dev/quansync" target="_blank">quansync-dev/quansync</a></span></li><li><span ws-nowrap=""><svg style="vertical-align:sub" class="inline inline-block" viewBox="0 0 32 32" width="1.2em" height="1.2em"><path fill="currentColor" fill-rule="evenodd" d="M16 2a14 14 0 0 0-4.43 27.28c.7.13 1-.3 1-.67v-2.38c-3.89.84-4.71-1.88-4.71-1.88a3.7 3.7 0 0 0-1.62-2.05c-1.27-.86.1-.85.1-.85a2.94 2.94 0 0 1 2.14 1.45a3 3 0 0 0 4.08 1.16a2.93 2.93 0 0 1 .88-1.87c-3.1-.36-6.37-1.56-6.37-6.92a5.4 5.4 0 0 1 1.44-3.76a5 5 0 0 1 .14-3.7s1.17-.38 3.85 1.43a13.3 13.3 0 0 1 7 0c2.67-1.81 3.84-1.43 3.84-1.43a5 5 0 0 1 .14 3.7a5.4 5.4 0 0 1 1.44 3.76c0 5.38-3.27 6.56-6.39 6.91a3.33 3.33 0 0 1 .95 2.59v3.84c0 .46.25.81 1 .67A14 14 0 0 0 16 2"></path></svg><a class="opacity-70 ml-1 font-mono" href="https://github.com/quansync-dev/unplugin-quansync" target="_blank">quansync-dev/unplugin-quansync</a></span></li></ul></div><!--]--></article><div class="prose m-auto mt-8 mb-8 slide-enter animate-delay-500 print:hidden"><!--[--><span font-mono="" op50="">&gt; </span><span op50="">comment on </span><a href="https://bsky.app/intent/compose?text=Reading%20%40antfu.me%20https%3A%2F%2Fantfu.me%2Fposts%2Fasync-sync-in-between%0A%0AI%20think..." target="_blank" op50="">bluesky</a><span op25=""> / </span><a href="https://elk.zone/intent/post?text=Reading%20%40antfu%40m.webtoo.ls's%20https%3A%2F%2Fantfu.me%2Fposts%2Fasync-sync-in-between%0A%0AI%20think..." target="_blank" op50="">mastodon</a><span op25=""> / </span><a href="https://twitter.com/intent/tweet?text=Reading%20%40antfu7's%20https%3A%2F%2Fantfu.me%2Fposts%2Fasync-sync-in-between%0A%0AI%20think..." target="_blank" op50="">twitter</a><!--]--><br><span font-mono="" op50="">&gt; </span><a href="/posts" class="router-link-active font-mono op50 hover:op75"></a></div><!--]--><div class="mt-10 mb-6 prose m-auto flex slide-enter animate-delay-1200! copyright"><span class="text-sm op50"><a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" style="color:inherit">CC BY-NC-SA 4.0</a> 2025 © Roman Merkulov</span><div class="flex-auto"></div></div></main><!----><!--]--></div><script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></body></html>